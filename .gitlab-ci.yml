stages:
  - validate
  - plan
  - provision
  - deploy
  - test
  - cleanup

variables:
  TF_ROOT: "terraform"

# -----------------------
# VALIDATE STAGE
# -----------------------

terraform_validate:
  stage: validate
  image:
    name: hashicorp/terraform:latest
    entrypoint: [""]
  script:
    - cd $TF_ROOT
    - terraform init -input=false
    - terraform fmt -check
    - terraform validate

terraform_lint:
  stage: validate
  image:
    name: ghcr.io/terraform-linters/tflint:latest
    entrypoint: [""]
  script:
    - cd $TF_ROOT
    - tflint

docker_validate:
  stage: validate
  image: docker:latest
  services:
    - docker:dind
  variables:
    DOCKER_HOST: tcp://docker:2375/
    DOCKER_TLS_CERTDIR: ""
  script:
    - docker compose config

# -----------------------
# PLAN STAGE
# -----------------------

terraform_plan:
  stage: plan
  image:
    name: hashicorp/terraform:latest
    entrypoint: [""]
  script:
    - cd $TF_ROOT
    - terraform init -input=false
    - terraform plan -out=tfplan
  artifacts:
    paths:
      - terraform/tfplan

# -----------------------
# PROVISION STAGE
# -----------------------

terraform_apply:
  stage: provision
  when: manual
  image:
    name: hashicorp/terraform:latest
    entrypoint: [""]
  script:
    - cd $TF_ROOT
    - terraform init -input=false
    - terraform apply -auto-approve
    - terraform output -raw public_ip > server_ip.txt
    - terraform output -raw private_key > ssh_key.pem
    - mv server_ip.txt ../server_ip.txt
    - mv ssh_key.pem ../ssh_key.pem
  artifacts:
    paths:
      - server_ip.txt
      - ssh_key.pem

# -----------------------
# DEPLOY STAGE
# -----------------------

deploy_directus:
  stage: deploy
  image: alpine:latest
  dependencies:
    - terraform_apply
  script:
    - apk add --no-cache openssh-client curl bash
    - chmod 600 ssh_key.pem
    - SERVER_IP=$(cat server_ip.txt)
    - |
      ssh -o StrictHostKeyChecking=no -i ssh_key.pem ubuntu@$SERVER_IP "
      mkdir -p ~/directus-app"
    - |
      scp -o StrictHostKeyChecking=no -i ssh_key.pem docker-compose.yml ubuntu@$SERVER_IP:~/directus-app/docker-compose.yml
    - |
      ssh -o StrictHostKeyChecking=no -i ssh_key.pem ubuntu@$SERVER_IP "
      cd ~/directus-app &&
      echo ADMIN_EMAIL=$ADMIN_EMAIL > .env &&
      echo ADMIN_PASSWORD=$ADMIN_PASSWORD >> .env &&
      echo DB_PASSWORD=$DB_PASSWORD >> .env &&
      echo DIRECTUS_SECRET=$DIRECTUS_SECRET >> .env &&
      docker compose up -d"
    - sleep 60

# --------------------
