stages:
  - validate
  - plan
  - provision
  - deploy
  - test
  - cleanup

variables:
  TF_ROOT: "terraform"

# -----------------------------
# VALIDATE STAGE
# -----------------------------

terraform_validate:
  stage: validate
  image: hashicorp/terraform:latest
  script:
    - cd $TF_ROOT
    - terraform init -input=false
    - terraform fmt -check
    - terraform validate
  artifacts:
    paths:
      - terraform/

terraform_plan:
  stage: plan
  image: hashicorp/terraform:latest
  script:
    - cd $TF_ROOT
    - terraform init -input=false
    - terraform plan -out=tfplan
  artifacts:
    paths:
      - terraform/tfplan

# -----------------------------
# PROVISION STAGE
# -----------------------------

terraform_apply:
  stage: provision
  image: hashicorp/terraform:latest
  when: manual
  script:
    - cd $TF_ROOT
    - terraform init -input=false
    - terraform apply -auto-approve
    - terraform output -raw public_ip > server_ip.txt
    - terraform output -raw private_key > ssh_key.pem
  artifacts:
    paths:
      - terraform/server_ip.txt
      - terraform/ssh_key.pem

# -----------------------------
# DEPLOY STAGE
# -----------------------------

deploy_directus:
  stage: deploy
  image: alpine:latest
  dependencies:
    - terraform_apply
  script:
    - apk add --no-cache openssh-client bash curl
    - chmod 600 terraform/ssh_key.pem
    - SERVER_IP=$(cat terraform/server_ip.txt)
    - |
      ssh -o StrictHostKeyChecking=no -i terraform/ssh_key.pem ubuntu@$SERVER_IP "
      mkdir -p ~/directus-app"
    - |
      scp -o StrictHostKeyChecking=no -i terraform/ssh_key.pem docker-compose.yml ubuntu@$SERVER_IP:~/directus-app/docker-compose.yml
    - |
      ssh -o StrictHostKeyChecking=no -i terraform/ssh_key.pem ubuntu@$SERVER_IP "
      cd ~/directus-app &&
      echo ADMIN_EMAIL=$ADMIN_EMAIL > .env &&
      echo ADMIN_PASSWORD=$ADMIN_PASSWORD >> .env &&
      echo DB_PASSWORD=$DB_PASSWORD >> .env &&
      echo DIRECTUS_SECRET=$DIRECTUS_SECRET >> .env &&
      docker compose up -d"
    - sleep 60

# -----------------------------
# TEST STAGE
# -----------------------------

health_check:
  stage: test
  image: curlimages/curl:latest
  dependencies:
    - terraform_apply
  script:
    - SERVER_IP=$(cat terraform/server_ip.txt)
    - curl -I http://$SERVER_IP:8055

capture_homepage:
  stage: test
  image: curlimages/curl:latest
  dependencies:
    - terraform_apply
  script:
    - SERVER_IP=$(cat terraform/server_ip.txt)
    - curl http://$SERVER_IP:8055 -o directus_homepage.html
  artifacts:
    paths:
      - directus_homepage.html

# -----------------------------
# CLEANUP STAGE
# -----------------------------

terraform_destroy:
  stage: cleanup
  image: hashicorp/terraform:latest
  when: manual
  script:
    - cd $TF_ROOT
    - terraform init -input=false
    - terraform destroy -auto-approve
